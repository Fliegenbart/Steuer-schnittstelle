<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BelegSync – KI-Belegverarbeitung</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
if (window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
<style>
/* ── Light Mode (Default) ──────────────────────── */
:root {
  --bg: #F5F7FA;
  --bg-card: #FFFFFF;
  --bg-card-hover: #F0F4F8;
  --bg-input: #F0F2F5;
  --border: #E2E8F0;
  --border-focus: #2563EB;
  --text: #1A1D23;
  --text-dim: #64748B;
  --text-muted: #94A3B8;
  --accent: #2563EB;
  --accent-light: #3B82F6;
  --accent-glow: rgba(37, 99, 235, 0.10);
  --success: #059669;
  --success-light: rgba(5, 150, 105, 0.10);
  --warning: #D97706;
  --warning-light: rgba(217, 119, 6, 0.10);
  --danger: #DC2626;
  --danger-light: rgba(220, 38, 38, 0.10);
  --purple: #7C3AED;
  --purple-light: rgba(124, 58, 237, 0.10);
  --pink: #EC4899;
  --pink-light: rgba(236, 72, 153, 0.10);
  --datev-green: #3CAA5F;
  --datev-green-light: rgba(60, 170, 95, 0.10);
  --radius: 12px;
  --radius-sm: 8px;
  --radius-xs: 6px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
  --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono: 'JetBrains Mono', 'SF Mono', monospace;
  --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
  --sidebar-bg: #FFFFFF;
  --sidebar-border: #E2E8F0;
  --topbar-bg: rgba(255,255,255,0.85);
  --modal-overlay: rgba(0,0,0,0.3);
}

/* ── Dark Mode ─────────────────────────────────── */
html[data-theme="dark"] {
  --bg: #0B0E11;
  --bg-card: #141922;
  --bg-card-hover: #1A2130;
  --bg-input: #0F1318;
  --border: #1E2736;
  --border-focus: #3B82F6;
  --text: #E8ECF1;
  --text-dim: #7A8699;
  --text-muted: #4A5568;
  --accent: #3B82F6;
  --accent-light: #60A5FA;
  --accent-glow: rgba(59, 130, 246, 0.15);
  --success-light: rgba(5, 150, 105, 0.15);
  --warning-light: rgba(217, 119, 6, 0.15);
  --danger-light: rgba(220, 38, 38, 0.15);
  --purple-light: rgba(124, 58, 237, 0.15);
  --pink-light: rgba(236, 72, 153, 0.15);
  --datev-green-light: rgba(60, 170, 95, 0.15);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
  --shadow: 0 2px 12px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.5);
  --sidebar-bg: #141922;
  --sidebar-border: #1E2736;
  --topbar-bg: rgba(20,25,34,0.85);
  --modal-overlay: rgba(0,0,0,0.7);
}

* { margin:0; padding:0; box-sizing:border-box; }
html { font-size: 15px; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ── Layout ─────────────────────────── */
.app { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--sidebar-border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}
.main { flex:1; margin-left: 260px; }
.topbar {
  height: 60px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 28px;
  background: var(--topbar-bg);
  position: sticky;
  top: 0; z-index: 50;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.content { padding: 28px; max-width: 1400px; }

/* ── Sidebar ────────────────────────── */
.logo {
  padding: 22px 22px 18px;
  border-bottom: 1px solid var(--border);
}
.logo h1 {
  font-size: 1.2rem;
  font-weight: 800;
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text);
}
.logo-icon {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  font-size: 0.9rem;
}
.logo .sub {
  font-size: 0.7rem;
  color: var(--text-dim);
  margin-top: 3px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  font-weight: 500;
}
.nav { flex:1; padding: 14px 12px; overflow-y: auto; }
.nav-section {
  font-size: 0.65rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1.2px;
  padding: 18px 12px 6px;
  font-weight: 600;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  color: var(--text-dim);
  font-size: 0.88rem;
  font-weight: 500;
  transition: all var(--transition);
  margin: 2px 0;
  border-left: 3px solid transparent;
  position: relative;
}
.nav-item:hover { background: var(--bg-card-hover); color: var(--text); }
.nav-item.active {
  background: var(--accent-glow);
  color: var(--accent);
  border-left-color: var(--accent);
  font-weight: 600;
}
.nav-item .nav-icon {
  width: 20px; height: 20px;
  flex-shrink: 0;
  opacity: 0.7;
}
.nav-item.active .nav-icon { opacity: 1; }
.nav-item .badge {
  margin-left: auto;
  background: var(--accent);
  color: #fff;
  font-size: 0.65rem;
  padding: 2px 7px;
  border-radius: 99px;
  font-weight: 700;
  min-width: 20px;
  text-align: center;
}
.datev-status {
  padding: 16px 18px;
  border-top: 1px solid var(--border);
  font-size: 0.78rem;
  display: flex;
  align-items: center;
  gap: 8px;
}
.datev-dot {
  display: inline-block;
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.datev-dot.connected { background: var(--datev-green); box-shadow: 0 0 6px var(--datev-green); }
.datev-dot.disconnected { background: var(--text-muted); }

/* ── Cards & Stats ──────────────────── */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}
.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 22px;
  transition: all var(--transition);
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
}
.stat-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
  background: var(--accent);
  border-radius: 0 4px 4px 0;
}
.stat-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow); }
.stat-card.success::before { background: var(--success); }
.stat-card.warning::before { background: var(--warning); }
.stat-card.danger::before { background: var(--danger); }
.stat-card.datev::before { background: var(--datev-green); }
.stat-card.purple::before { background: var(--purple); }
.stat-label {
  font-size: 0.72rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  font-weight: 600;
}
.stat-value {
  font-size: 2rem;
  font-weight: 800;
  margin-top: 6px;
  font-variant-numeric: tabular-nums;
  letter-spacing: -1px;
}
.stat-sub { font-size: 0.78rem; color: var(--text-dim); margin-top: 4px; }

.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}
.card-header {
  padding: 16px 22px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 600;
  font-size: 0.92rem;
}
.card-body { padding: 20px 22px; }

/* ── Buttons ────────────────────────── */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 9px 18px;
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 0.84rem;
  font-weight: 600;
  border: 1px solid transparent;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}
.btn-primary {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}
.btn-primary:hover { background: #1D4ED8; box-shadow: 0 4px 12px var(--accent-glow); }
.btn-success { background: var(--datev-green); color: #fff; }
.btn-success:hover { background: #2F9651; }
.btn-ghost {
  background: transparent;
  color: var(--text-dim);
  border-color: var(--border);
}
.btn-ghost:hover { color: var(--text); border-color: var(--text-muted); background: var(--bg-card-hover); }
.btn-danger { background: transparent; color: var(--danger); border-color: var(--danger); }
.btn-danger:hover { background: var(--danger-light); }
.btn-sm { padding: 6px 12px; font-size: 0.76rem; }

/* ── Forms ──────────────────────────── */
.form-group { margin-bottom: 14px; }
.form-label {
  display: block;
  font-size: 0.76rem;
  font-weight: 600;
  color: var(--text-dim);
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.form-input, .form-select {
  width: 100%;
  padding: 9px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: var(--font);
  font-size: 0.88rem;
  transition: all var(--transition);
  -webkit-appearance: none;
}
.form-input:focus, .form-select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

/* ── Table ──────────────────────────── */
.table-wrap { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.84rem;
}
th {
  text-align: left;
  padding: 12px 16px;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  font-weight: 600;
  border-bottom: 2px solid var(--border);
  background: var(--bg-card);
}
td {
  padding: 13px 16px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}
tr:hover td { background: var(--bg-card-hover); }
tr { cursor: pointer; transition: background var(--transition); }

/* ── Status Badges ──────────────────── */
.badge-status {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 99px;
  font-size: 0.72rem;
  font-weight: 600;
}
.badge-status::before {
  content: '';
  width: 6px; height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}
.badge-hochgeladen { background: rgba(148,163,184,0.12); color: #64748B; }
.badge-hochgeladen::before { background: #94A3B8; }
.badge-ocr_laeuft, .badge-extraktion_laeuft { background: var(--accent-glow); color: var(--accent); }
.badge-ocr_laeuft::before, .badge-extraktion_laeuft::before { background: var(--accent); animation: pulse 1.5s infinite; }
.badge-extrahiert { background: var(--warning-light); color: var(--warning); }
.badge-extrahiert::before { background: var(--warning); }
.badge-geprueft { background: var(--success-light); color: var(--success); }
.badge-geprueft::before { background: var(--success); }
.badge-an_datev { background: var(--datev-green-light); color: var(--datev-green); }
.badge-an_datev::before { background: var(--datev-green); }
.badge-fehler { background: var(--danger-light); color: var(--danger); }
.badge-fehler::before { background: var(--danger); }

.konfidenz-hoch { color: var(--success); font-weight: 600; }
.konfidenz-mittel { color: var(--warning); font-weight: 600; }
.konfidenz-niedrig { color: var(--danger); font-weight: 600; }

.konfidenz-dot {
  display: inline-block;
  width: 8px; height: 8px;
  border-radius: 50%;
  margin-right: 5px;
  vertical-align: middle;
}

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* ── Upload Drop Zone ───────────────── */
.dropzone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 48px 40px;
  text-align: center;
  cursor: pointer;
  transition: all var(--transition);
  background: var(--bg-card);
  box-shadow: var(--shadow-sm);
}
.dropzone:hover, .dropzone.dragover {
  border-color: var(--accent);
  background: var(--accent-glow);
  box-shadow: 0 0 0 4px var(--accent-glow);
}
.dropzone-icon {
  width: 48px; height: 48px;
  margin: 0 auto 12px;
  border-radius: 12px;
  background: var(--accent-glow);
  display: flex;
  align-items: center;
  justify-content: center;
}
.dropzone-icon svg { width: 24px; height: 24px; color: var(--accent); }
.dropzone p { color: var(--text-dim); font-size: 0.88rem; }
.dropzone .drop-hint { font-size: 0.76rem; margin-top: 6px; color: var(--text-muted); }

/* ── Source Grounding View ──────────── */
.source-view {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-top: 16px;
  position: relative;
}
.ocr-panel {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  max-height: 520px;
  overflow-y: auto;
  font-family: var(--mono);
  font-size: 0.78rem;
  line-height: 1.8;
  white-space: pre-wrap;
  word-break: break-word;
  position: relative;
}

/* Source Grounding Highlights */
.ocr-highlight {
  padding: 2px 4px;
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  transition: all 0.2s ease;
  border-bottom: 2px solid;
}
.ocr-highlight:hover { filter: brightness(0.95); }

/* Dimmed state when a field is selected */
.ocr-highlight.dimmed { opacity: 0.25; }
.ocr-highlight.active-highlight {
  animation: highlightPulse 1.5s ease-in-out 2;
  box-shadow: 0 0 8px currentColor;
}

@keyframes highlightPulse {
  0%, 100% { box-shadow: 0 0 4px currentColor; }
  50% { box-shadow: 0 0 16px currentColor; }
}

/* Per-Feld Farben */
.ocr-highlight[data-feld="aussteller"] {
  background: rgba(37,99,235,0.12); border-color: var(--accent);
}
.ocr-highlight[data-feld="betrag_brutto"],
.ocr-highlight[data-feld="betrag_netto"],
.ocr-highlight[data-feld="mwst_betrag"] {
  background: var(--success-light); border-color: var(--success);
}
.ocr-highlight[data-feld="datum_beleg"] {
  background: var(--purple-light); border-color: var(--purple);
}
.ocr-highlight[data-feld="rechnungsnummer"] {
  background: var(--pink-light); border-color: var(--pink);
}
.ocr-highlight[data-feld="arbeitskosten_35a"] {
  background: var(--datev-green-light); border-color: var(--datev-green);
}
.ocr-highlight[data-feld="materialkosten"] {
  background: var(--warning-light); border-color: var(--warning);
}

/* Hover-Tooltips */
.ocr-highlight[data-tooltip]:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: var(--bg-card);
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.68rem;
  font-family: var(--font);
  white-space: nowrap;
  z-index: 20;
  pointer-events: none;
  box-shadow: var(--shadow);
}

.extraction-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 4px 0;
}
.ext-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 18px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
}
.ext-field:last-child { border-bottom: none; }
.ext-field:hover { background: var(--bg-card-hover); }
.ext-field.active-field { background: var(--accent-glow); }
.ext-field.dimmed { opacity: 0.25; }
.ext-label {
  font-size: 0.74rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}
.ext-value {
  font-weight: 600;
  font-family: var(--mono);
  font-size: 0.86rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Grounding Badges */
.grounding-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px; height: 18px;
  border-radius: 50%;
  font-size: 0.6rem;
  flex-shrink: 0;
}
.grounding-badge.grounded {
  background: var(--success-light);
  color: var(--success);
}
.grounding-badge.ungrounded {
  background: var(--warning-light);
  color: var(--warning);
}

/* SVG Connector Overlay */
.source-connector-svg {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 10;
}
.connector-line {
  fill: none;
  stroke-width: 2;
  stroke-dasharray: 6 4;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.connector-line.active { opacity: 1; }

/* ── Document Viewer Tabs ──────────── */
.doc-tabs {
  display: flex;
  gap: 2px;
  margin-bottom: 8px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  padding: 3px;
}
.doc-tab {
  flex: 1;
  padding: 8px 14px;
  font-size: 0.78rem;
  font-weight: 600;
  text-align: center;
  border-radius: var(--radius-xs);
  cursor: pointer;
  color: var(--text-dim);
  transition: all var(--transition);
  border: none;
  background: transparent;
  font-family: var(--font);
}
.doc-tab:hover { color: var(--text); }
.doc-tab.active {
  background: var(--bg-card);
  color: var(--text);
  box-shadow: var(--shadow-sm);
}

/* ── PDF/Image Viewer Container ────── */
.pdf-container {
  position: relative;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  max-height: 520px;
  overflow-y: auto;
}
.pdf-canvas-wrap {
  position: relative;
  display: inline-block;
  width: 100%;
}
.pdf-canvas {
  display: block;
  width: 100%;
  height: auto;
}
.pdf-img {
  display: block;
  width: 100%;
  height: auto;
}
.bbox-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}
.bbox-overlay rect {
  pointer-events: all;
  cursor: pointer;
  transition: all 0.2s ease;
}
.bbox-overlay rect.dimmed { opacity: 0.1; }
.bbox-overlay rect.active-bbox {
  animation: bboxPulse 1.5s ease-in-out 2;
}
@keyframes bboxPulse {
  0%, 100% { stroke-width: 2; }
  50% { stroke-width: 4; }
}

/* ── Legende ───────────────────────── */
.legend {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-bottom: 16px;
  font-size: 0.72rem;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  color: var(--text-dim);
}
.legend-dot {
  width: 10px; height: 10px;
  border-radius: 3px;
  flex-shrink: 0;
}

/* ── Missing Docs ───────────────────── */
.missing-item {
  padding: 10px 14px;
  font-size: 0.84rem;
  border-left: 3px solid;
  margin: 4px 0;
  border-radius: 0 var(--radius-xs) var(--radius-xs) 0;
  background: var(--bg-input);
}

/* ── Modal ──────────────────────────── */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--modal-overlay);
  backdrop-filter: blur(4px);
  z-index: 200;
  align-items: center;
  justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  width: 92%;
  max-width: 1100px;
  max-height: 88vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: modalIn 0.25s ease;
}
@keyframes modalIn {
  from { opacity: 0; transform: scale(0.96) translateY(8px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}
.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 700;
  font-size: 1.05rem;
  position: sticky;
  top: 0;
  background: var(--bg-card);
  z-index: 10;
}
.modal-body { padding: 24px; }
.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  position: sticky;
  bottom: 0;
  background: var(--bg-card);
}
.close-btn {
  background: none; border: none; color: var(--text-dim);
  font-size: 1.2rem; cursor: pointer;
  width: 32px; height: 32px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
}
.close-btn:hover { color: var(--text); background: var(--bg-card-hover); }

/* ── Progress Bar ───────────────────── */
.progress-bar {
  height: 6px;
  background: var(--bg-input);
  border-radius: 99px;
  overflow: hidden;
  margin-top: 6px;
}
.progress-fill {
  height: 100%;
  border-radius: 99px;
  background: linear-gradient(90deg, var(--accent), var(--purple));
  transition: width 0.5s ease;
}

/* ── Progress Ring (Dashboard) ─────── */
.progress-ring { position: relative; display: inline-block; }
.progress-ring svg { transform: rotate(-90deg); }
.progress-ring .ring-value {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 0.9rem;
  font-weight: 800;
}

/* ── Theme Toggle ──────────────────── */
.theme-toggle {
  width: 36px; height: 36px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg-input);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
  font-size: 1rem;
  color: var(--text-dim);
}
.theme-toggle:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }

/* ── Animations ─────────────────────── */
@keyframes fadeIn {
  from { opacity:0; transform: translateY(8px); }
  to { opacity:1; transform: translateY(0); }
}
.animate-in { animation: fadeIn 0.3s ease forwards; }
.view { display: none; }
.view.active { display: block; }

/* ── Responsive ─────────────────────── */
@media (max-width: 900px) {
  .sidebar { display: none; }
  .main { margin-left: 0; }
  .source-view { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <h1>
        <div class="logo-icon">B</div>
        BelegSync
      </h1>
      <div class="sub">KI-Belegverarbeitung</div>
    </div>
    <nav class="nav">
      <div class="nav-section">Ubersicht</div>
      <div class="nav-item active" data-view="dashboard" onclick="showView('dashboard')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </div>

      <div class="nav-section">Verwaltung</div>
      <div class="nav-item" data-view="mandanten" onclick="showView('mandanten')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
        Mandanten
      </div>

      <div class="nav-section">Verarbeitung</div>
      <div class="nav-item" data-view="belege" onclick="showView('belege')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Belege <span class="badge" id="belege-badge">0</span>
      </div>

      <div class="nav-section">DATEV</div>
      <div class="nav-item" data-view="datev" onclick="showView('datev')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
        DATEV Sync
      </div>
    </nav>

    <div class="datev-status" id="datev-status-bar">
      <span class="datev-dot disconnected" id="datev-dot"></span>
      <span id="datev-label">DATEV nicht verbunden</span>
    </div>
  </aside>

  <!-- Main -->
  <div class="main">
    <header class="topbar">
      <div id="topbar-title" style="font-weight:700; font-size: 1rem;">Dashboard</div>
      <div style="display:flex;gap:10px;align-items:center;">
        <select class="form-select" id="mandant-select" style="width:240px;" onchange="onMandantChange()">
          <option value="">Mandant wahlen...</option>
        </select>
        <select class="form-select" id="sj-select" style="width:130px;" onchange="onSteuerjahrChange()">
          <option value="">Jahr...</option>
        </select>
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn" title="Dark/Light Mode">
          <span id="theme-icon">&#9790;</span>
        </button>
      </div>
    </header>

    <div class="content">

      <!-- Dashboard View -->
      <div class="view active" id="view-dashboard">
        <div class="stats-grid" id="stats-grid"></div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card">
            <div class="card-header">
              <span>Letzte Belege</span>
            </div>
            <div class="card-body" id="recent-belege">
              <p style="color:var(--text-dim);">Mandant und Steuerjahr wahlen</p>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <span>Fehlende Unterlagen</span>
            </div>
            <div class="card-body" id="missing-docs">
              <p style="color:var(--text-dim);">Wird nach Beleganalyse angezeigt</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Mandanten View -->
      <div class="view" id="view-mandanten">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2 style="font-size:1.2rem;font-weight:700;">Mandanten</h2>
          <button class="btn btn-primary" onclick="showNewMandant()">+ Neuer Mandant</button>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Name</th><th>Firma</th><th>Steuernummer</th><th>DATEV Nr.</th><th>Steuerjahre</th><th></th></tr>
              </thead>
              <tbody id="mandanten-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Belege View -->
      <div class="view" id="view-belege">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2 style="font-size:1.2rem;font-weight:700;">
            Belege <span id="belege-count" style="color:var(--text-dim);font-weight:400;"></span>
          </h2>
          <div style="display:flex;gap:10px;">
            <button class="btn btn-ghost" onclick="refreshBelege()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
              Aktualisieren
            </button>
          </div>
        </div>

        <!-- Upload Zone -->
        <div class="dropzone" id="dropzone"
             ondragover="event.preventDefault();this.classList.add('dragover')"
             ondragleave="this.classList.remove('dragover')"
             ondrop="handleDrop(event)"
             onclick="document.getElementById('file-input').click()">
          <div class="dropzone-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          </div>
          <p><strong>Belege hochladen</strong> – Dateien hierher ziehen oder klicken</p>
          <p class="drop-hint">PDF, JPG, PNG – Max 50 MB</p>
          <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.tiff,.bmp" style="display:none" onchange="handleFiles(this.files)">
        </div>

        <div id="upload-progress" style="display:none;margin:16px 0;">
          <div style="display:flex;justify-content:space-between;font-size:0.82rem;">
            <span id="upload-text">Wird hochgeladen...</span>
            <span id="upload-pct">0%</span>
          </div>
          <div class="progress-bar"><div class="progress-fill" id="upload-bar" style="width:0%"></div></div>
        </div>

        <!-- Belege Table -->
        <div class="card" style="margin-top:16px;">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Datei</th><th>Typ</th><th>Aussteller</th><th>Betrag</th><th>Konto</th><th>Status</th><th>Konfidenz</th><th>DATEV</th></tr>
              </thead>
              <tbody id="belege-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- DATEV View -->
      <div class="view" id="view-datev">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2 style="font-size:1.2rem;font-weight:700;">DATEV Integration</h2>
          <div style="display:flex;gap:10px;">
            <button class="btn btn-success" onclick="syncToDATEV(false)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
              Gepruefte an DATEV senden
            </button>
            <button class="btn btn-ghost" onclick="exportCSV()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              CSV Export
            </button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Verbindung</div>
            <div id="datev-connection" style="margin-top:8px;">Wird geprueft...</div>
          </div>
          <div class="stat-card datev">
            <div class="stat-label">Bereit zum Sync</div>
            <div class="stat-value" id="datev-ready">-</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">Gesynced</div>
            <div class="stat-value" id="datev-synced" style="color:var(--datev-green);">-</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-label">Fehler</div>
            <div class="stat-value" id="datev-errors" style="color:var(--danger);">-</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Sync-Protokoll</div>
          <div class="card-body" id="sync-log">
            <p style="color:var(--text-dim);">Noch keine Sync-Aktivitat</p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Beleg Detail Modal -->
<div class="modal-overlay" id="beleg-modal">
  <div class="modal">
    <div class="modal-header">
      <span id="modal-title">Beleg Details</span>
      <button class="close-btn" onclick="closeModal()">&#10005;</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer" id="modal-footer"></div>
  </div>
</div>

<!-- New Mandant Modal -->
<div class="modal-overlay" id="mandant-modal">
  <div class="modal" style="max-width:520px;">
    <div class="modal-header">
      <span>Neuer Mandant</span>
      <button class="close-btn" onclick="document.getElementById('mandant-modal').classList.remove('show')">&#10005;</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Name *</label><input class="form-input" id="m-name"></div>
      <div class="form-group"><label class="form-label">Firma</label><input class="form-input" id="m-firma"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-group"><label class="form-label">Steuernummer</label><input class="form-input" id="m-stnr"></div>
        <div class="form-group"><label class="form-label">Steuer-ID</label><input class="form-input" id="m-stid"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-group"><label class="form-label">DATEV Berater-Nr.</label><input class="form-input" id="m-bnr"></div>
        <div class="form-group"><label class="form-label">DATEV Mandant-Nr.</label><input class="form-input" id="m-mnr"></div>
      </div>
      <div class="form-group"><label class="form-label">E-Mail</label><input class="form-input" id="m-email" type="email"></div>
      <div class="form-group"><label class="form-label">Steuerjahr anlegen</label><input class="form-input" id="m-jahr" type="number" value="2024" min="2018" max="2026"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="document.getElementById('mandant-modal').classList.remove('show')">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveMandant()">Speichern</button>
    </div>
  </div>
</div>

<script>
const API = '';
let state = {
  mandanten: [],
  mandantId: null,
  steuerjahrId: null,
  belege: [],
  activeField: null,  // Source Grounding: aktuell selektiertes Feld
};

// ── API Helpers ──────────────────────
async function api(path, opts = {}) {
  const res = await fetch(API + path, {
    headers: { 'Content-Type': 'application/json', ...opts.headers },
    ...opts,
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.detail || res.statusText);
  }
  return res.json();
}

function fmt(n) {
  if (n == null) return '-';
  return new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
}

function statusLabel(s) {
  const map = {
    hochgeladen: 'Hochgeladen', ocr_laeuft: 'OCR lauft', ocr_fertig: 'OCR fertig',
    extraktion_laeuft: 'Extraktion...', extrahiert: 'Extrahiert',
    geprueft: 'Geprueft', an_datev: 'An DATEV', fehler: 'Fehler',
  };
  return '<span class="badge-status badge-' + s + '">' + (map[s] || s) + '</span>';
}

// ── Theme Toggle ─────────────────────
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('belegsync-theme', next);
  updateThemeIcon(next);
}

function updateThemeIcon(theme) {
  const icon = document.getElementById('theme-icon');
  icon.innerHTML = theme === 'dark' ? '&#9788;' : '&#9790;';
}

function initTheme() {
  const saved = localStorage.getItem('belegsync-theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  updateThemeIcon(saved);
}

// ── Navigation ───────────────────────
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view === name));
  const titles = { dashboard: 'Dashboard', mandanten: 'Mandanten', belege: 'Belege', datev: 'DATEV Integration' };
  document.getElementById('topbar-title').textContent = titles[name] || name;
  if (name === 'datev') loadDATEVStatus();
}

// ── Init ─────────────────────────────
async function init() {
  initTheme();
  await loadMandanten();

  // Auto-select first Mandant if none selected
  if (!state.mandantId && state.mandanten.length > 0) {
    await selectMandant(state.mandanten[0].id);
  }

  loadDashboard();
  checkDATEV();
}

// ── Mandanten ────────────────────────
async function loadMandanten() {
  state.mandanten = await api('/api/mandanten');
  const sel = document.getElementById('mandant-select');
  sel.innerHTML = '<option value="">Mandant wahlen...</option>' +
    state.mandanten.map(m => '<option value="' + m.id + '">' + m.name + (m.firma ? ' - ' + m.firma : '') + '</option>').join('');

  renderMandantenTable();
  if (state.mandantId) sel.value = state.mandantId;
}

function renderMandantenTable() {
  document.getElementById('mandanten-table').innerHTML = state.mandanten.map(m =>
    '<tr onclick="selectMandant(' + m.id + ')">' +
      '<td><strong>' + m.name + '</strong></td>' +
      '<td>' + (m.firma || '-') + '</td>' +
      '<td style="font-family:var(--mono);font-size:0.82rem;">' + (m.steuernummer || '-') + '</td>' +
      '<td style="font-family:var(--mono);font-size:0.82rem;">' + (m.datev_berater_nr || '-') + '/' + (m.datev_mandant_nr || '-') + '</td>' +
      '<td>' + m.anzahl_steuerjahre + '</td>' +
      '<td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteMandant(' + m.id + ')">&#128465;</button></td>' +
    '</tr>'
  ).join('');
}

async function selectMandant(id) {
  state.mandantId = id;
  document.getElementById('mandant-select').value = id;
  await loadSteuerjahre();
}

async function onMandantChange() {
  const id = document.getElementById('mandant-select').value;
  if (!id) return;
  await selectMandant(parseInt(id));
}

function showNewMandant() {
  ['m-name','m-firma','m-stnr','m-stid','m-bnr','m-mnr','m-email'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('m-jahr').value = '2024';
  document.getElementById('mandant-modal').classList.add('show');
}

async function saveMandant() {
  const name = document.getElementById('m-name').value.trim();
  if (!name) return alert('Name erforderlich');
  const m = await api('/api/mandanten', {
    method: 'POST',
    body: JSON.stringify({
      name,
      firma: document.getElementById('m-firma').value || null,
      steuernummer: document.getElementById('m-stnr').value || null,
      steuer_id: document.getElementById('m-stid').value || null,
      datev_berater_nr: document.getElementById('m-bnr').value || null,
      datev_mandant_nr: document.getElementById('m-mnr').value || null,
      email: document.getElementById('m-email').value || null,
    }),
  });

  const jahr = parseInt(document.getElementById('m-jahr').value);
  if (jahr) {
    await api('/api/steuerjahre', {
      method: 'POST',
      body: JSON.stringify({ mandant_id: m.id, jahr }),
    });
  }

  document.getElementById('mandant-modal').classList.remove('show');
  await loadMandanten();
  await selectMandant(m.id);
}

async function deleteMandant(id) {
  if (!confirm('Mandant und alle Daten loschen?')) return;
  await api('/api/mandanten/' + id, { method: 'DELETE' });
  await loadMandanten();
}

// ── Steuerjahre ──────────────────────
async function loadSteuerjahre() {
  if (!state.mandantId) return;
  const sjs = await api('/api/steuerjahre/mandant/' + state.mandantId);
  const sel = document.getElementById('sj-select');
  sel.innerHTML = '<option value="">Jahr...</option>' +
    sjs.map(s => '<option value="' + s.id + '">' + s.jahr + ' (' + s.anzahl_belege + ' Belege)</option>').join('');

  if (sjs.length > 0) {
    state.steuerjahrId = sjs[0].id;
    sel.value = sjs[0].id;
    await loadBelege();
    renderMissing(sjs[0].vollstaendigkeit);
  }
}

async function onSteuerjahrChange() {
  state.steuerjahrId = parseInt(document.getElementById('sj-select').value);
  if (state.steuerjahrId) await loadBelege();
}

// ── Dashboard ────────────────────────
async function loadDashboard() {
  try {
    const d = await api('/api/dashboard');
    const ring = buildProgressRing(d.extraktion_rate, 52, 5);
    document.getElementById('stats-grid').innerHTML =
      '<div class="stat-card animate-in"><div class="stat-label">Mandanten</div><div class="stat-value">' + d.mandanten_aktiv + '</div></div>' +
      '<div class="stat-card purple animate-in" style="animation-delay:50ms"><div class="stat-label">Belege gesamt</div><div class="stat-value">' + d.belege_gesamt + '</div></div>' +
      '<div class="stat-card warning animate-in" style="animation-delay:100ms"><div class="stat-label">Offen</div><div class="stat-value" style="color:var(--warning)">' + d.belege_offen + '</div></div>' +
      '<div class="stat-card success animate-in" style="animation-delay:150ms"><div class="stat-label">Geprueft</div><div class="stat-value" style="color:var(--success)">' + d.belege_geprueft + '</div></div>' +
      '<div class="stat-card datev animate-in" style="animation-delay:200ms"><div class="stat-label">An DATEV</div><div class="stat-value" style="color:var(--datev-green)">' + d.belege_synced + '</div></div>' +
      '<div class="stat-card animate-in" style="animation-delay:250ms"><div class="stat-label">Extraktionsrate</div><div style="display:flex;align-items:center;gap:16px;margin-top:6px;">' + ring + '</div></div>' +
      '<div class="stat-card animate-in" style="animation-delay:300ms"><div class="stat-label">Summe Brutto</div><div class="stat-value">' + fmt(d.summe_brutto) + ' &euro;</div></div>';
    document.getElementById('belege-badge').textContent = d.belege_offen;
  } catch(e) { console.error(e); }
}

function buildProgressRing(pct, size, stroke) {
  const r = (size - stroke) / 2;
  const circ = 2 * Math.PI * r;
  const offset = circ - (pct / 100) * circ;
  return '<div class="progress-ring">' +
    '<svg width="' + size + '" height="' + size + '">' +
    '<circle cx="' + size/2 + '" cy="' + size/2 + '" r="' + r + '" fill="none" stroke="var(--border)" stroke-width="' + stroke + '"/>' +
    '<circle cx="' + size/2 + '" cy="' + size/2 + '" r="' + r + '" fill="none" stroke="var(--accent)" stroke-width="' + stroke + '" stroke-linecap="round" stroke-dasharray="' + circ + '" stroke-dashoffset="' + offset + '" style="transition:stroke-dashoffset 1s ease;"/>' +
    '</svg>' +
    '<span class="ring-value">' + pct + '%</span></div>';
}

// ── Belege ───────────────────────────
async function loadBelege() {
  if (!state.steuerjahrId) return;
  state.belege = await api('/api/belege/steuerjahr/' + state.steuerjahrId);
  renderBelege();
  renderRecentBelege();
  loadDashboard();
}

function refreshBelege() { loadBelege(); }

function renderBelege() {
  document.getElementById('belege-count').textContent = '(' + state.belege.length + ')';
  document.getElementById('belege-table').innerHTML = state.belege.map(b => {
    const konfDot = b.extraktion_konfidenz === 'hoch' ? 'var(--success)' : (b.extraktion_konfidenz === 'mittel' ? 'var(--warning)' : 'var(--danger)');
    return '<tr onclick="openBeleg(' + b.id + ')">' +
      '<td title="' + b.dateiname + '" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + b.dateiname + '</td>' +
      '<td>' + (b.beleg_typ || '-') + '</td>' +
      '<td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (b.aussteller || '-') + '</td>' +
      '<td style="font-family:var(--mono);text-align:right;">' + (b.betrag_brutto != null ? fmt(b.betrag_brutto) + ' &euro;' : '-') + '</td>' +
      '<td style="font-family:var(--mono);">' + (b.skr03_konto || '-') + '</td>' +
      '<td>' + statusLabel(b.status) + '</td>' +
      '<td>' + (b.extraktion_konfidenz ? '<span class="konfidenz-dot" style="background:' + konfDot + '"></span><span class="konfidenz-' + b.extraktion_konfidenz + '">' + b.extraktion_konfidenz + '</span>' : '-') + '</td>' +
      '<td>' + (b.datev_sync_status === 'synced' ? '<span style="color:var(--datev-green);font-weight:700;">&#10003;</span>' : (b.datev_sync_status === 'error' ? '<span style="color:var(--danger);">&#10007;</span>' : '-')) + '</td>' +
    '</tr>';
  }).join('') || '<tr><td colspan="8" style="text-align:center;color:var(--text-dim);padding:40px;">Keine Belege vorhanden</td></tr>';
}

function renderRecentBelege() {
  const recent = state.belege.slice(0, 5);
  document.getElementById('recent-belege').innerHTML = recent.map(b =>
    '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.84rem;cursor:pointer;" onclick="openBeleg(' + b.id + ')">' +
      '<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">' + b.dateiname + '</span>' +
      '<span>' + statusLabel(b.status) + '</span>' +
    '</div>'
  ).join('') || '<p style="color:var(--text-dim);">Keine Belege</p>';
}

function renderMissing(v) {
  if (!v || !v.empfehlungen || v.empfehlungen.length === 0) {
    document.getElementById('missing-docs').innerHTML = '<p style="color:var(--success);font-weight:600;">&#10003; Alle erwarteten Belege vorhanden</p>';
    return;
  }
  document.getElementById('missing-docs').innerHTML = v.empfehlungen.map(e => {
    var color = e.startsWith('\uD83D\uDD34') ? 'var(--danger)' : (e.startsWith('\uD83D\uDFE1') ? 'var(--warning)' : 'var(--accent)');
    return '<div class="missing-item" style="border-left-color:' + color + ';">' + e + '</div>';
  }).join('');
}

// ── Upload ───────────────────────────
function handleDrop(e) {
  e.preventDefault();
  document.getElementById('dropzone').classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
}

async function handleFiles(files) {
  if (!state.steuerjahrId) return alert('Bitte Mandant und Steuerjahr wahlen');
  if (!files.length) return;

  var prog = document.getElementById('upload-progress');
  var bar = document.getElementById('upload-bar');
  var text = document.getElementById('upload-text');
  var pct = document.getElementById('upload-pct');
  prog.style.display = 'block';

  var fd = new FormData();
  for (var i = 0; i < files.length; i++) fd.append('files', files[i]);

  text.textContent = files.length + ' Datei(en) werden hochgeladen...';
  bar.style.width = '30%';
  pct.textContent = '30%';

  try {
    var res = await fetch('/api/belege/upload/' + state.steuerjahrId, { method: 'POST', body: fd });
    bar.style.width = '70%';
    pct.textContent = '70%';

    if (!res.ok) throw new Error((await res.json()).detail || 'Upload fehlgeschlagen');

    var uploaded = await res.json();
    bar.style.width = '100%';
    pct.textContent = '100%';
    text.textContent = '\u2713 ' + uploaded.length + ' Beleg(e) hochgeladen - Verarbeitung lauft...';

    setTimeout(async function() {
      await loadBelege();
      prog.style.display = 'none';
    }, 2000);

    var polls = 0;
    var interval = setInterval(async function() {
      await loadBelege();
      polls++;
      var processing = state.belege.filter(function(b) { return ['hochgeladen','ocr_laeuft','ocr_fertig','extraktion_laeuft'].indexOf(b.status) >= 0; });
      if (processing.length === 0 || polls > 30) {
        clearInterval(interval);
        prog.style.display = 'none';
      }
    }, 3000);

  } catch(e) {
    text.textContent = '\u2717 ' + e.message;
    bar.style.width = '100%';
    bar.style.background = 'var(--danger)';
    setTimeout(function() { prog.style.display = 'none'; bar.style.background = ''; }, 4000);
  }
}

// ── Beleg Detail Modal ───────────────

// Feld-Farben Map
var FELD_COLORS = {
  aussteller: { color: '#2563EB', label: 'Aussteller' },
  betrag_brutto: { color: '#059669', label: 'Betrag brutto' },
  betrag_netto: { color: '#059669', label: 'Betrag netto' },
  mwst_betrag: { color: '#059669', label: 'MwSt' },
  datum_beleg: { color: '#7C3AED', label: 'Datum' },
  rechnungsnummer: { color: '#EC4899', label: 'Rechnungsnr.' },
  arbeitskosten_35a: { color: '#3CAA5F', label: '\u00a735a Arbeitskosten' },
  materialkosten: { color: '#D97706', label: 'Materialkosten' },
};

function getFeldColor(feld) {
  return (FELD_COLORS[feld] && FELD_COLORS[feld].color) || '#2563EB';
}

function getFeldLabel(feld) {
  return (FELD_COLORS[feld] && FELD_COLORS[feld].label) || feld;
}

async function openBeleg(id) {
  state.activeField = null;
  state.activeTab = 'doc';  // default: Dokument tab
  state.currentBeleg = null;
  var b = await api('/api/belege/' + id);
  state.currentBeleg = b;
  document.getElementById('modal-title').textContent = b.dateiname;

  // Determine if document view is available
  var hasFile = b.dateipfad && b.dateipfad.length > 5;
  var fileUrl = hasFile ? getFileUrl(b.dateipfad) : null;
  var hasBboxes = hasFile && b.quellreferenzen && b.quellreferenzen.some(function(s) { return s.bbox; });

  // If no file, default to text tab
  if (!hasFile) state.activeTab = 'text';

  // Build source-grounded OCR view
  var ocrHtml = '<p style="color:var(--text-dim);">Kein OCR-Text</p>';
  if (b.ocr_text) {
    ocrHtml = buildSourceGroundedText(b.ocr_text, b.quellreferenzen || []);
  }

  // Build extraction fields
  var fields = [
    ['beleg_typ', 'Belegtyp', b.beleg_typ],
    ['aussteller', 'Aussteller', b.aussteller],
    ['beschreibung', 'Beschreibung', b.beschreibung],
    ['datum_beleg', 'Datum', b.datum_beleg],
    ['rechnungsnummer', 'Rechnungsnr.', b.rechnungsnummer],
    ['betrag_brutto', 'Brutto', b.betrag_brutto != null ? fmt(b.betrag_brutto) + ' \u20ac' : null],
    ['betrag_netto', 'Netto', b.betrag_netto != null ? fmt(b.betrag_netto) + ' \u20ac' : null],
    ['mwst_satz', 'MwSt-Satz', b.mwst_satz != null ? b.mwst_satz + '%' : null],
    ['mwst_betrag', 'MwSt-Betrag', b.mwst_betrag != null ? fmt(b.mwst_betrag) + ' \u20ac' : null],
    ['skr03_konto', 'SKR03-Konto', b.skr03_konto ? b.skr03_konto + (b.skr03_bezeichnung ? ' - ' + b.skr03_bezeichnung : '') : null],
    ['gegenkonto', 'Gegenkonto', b.gegenkonto],
    ['bu_schluessel', 'BU-Schluessel', b.bu_schluessel],
    ['steuer_kategorie', 'Steuer-Kategorie', b.steuer_kategorie],
    ['arbeitskosten_35a', '\u00a735a Arbeitskosten', b.paragraph_35a_anteil != null ? fmt(b.paragraph_35a_anteil) + ' \u20ac' : null],
    ['materialkosten', 'Materialkosten', b.materialkosten != null ? fmt(b.materialkosten) + ' \u20ac' : null],
  ];

  var groundedFields = {};
  (b.quellreferenzen || []).forEach(function(s) { if (s.feld) groundedFields[s.feld] = true; });

  var fieldsHtml = fields.map(function(f) {
    var key = f[0], label = f[1], value = f[2];
    if (!value) return '';
    var isGrounded = groundedFields[key];
    var badge = isGrounded
      ? '<span class="grounding-badge grounded" title="Quellenreferenz im OCR-Text gefunden">&#10003;</span>'
      : '<span class="grounding-badge ungrounded" title="Keine Quellenreferenz">?</span>';
    return '<div class="ext-field" data-field-key="' + key + '" onclick="selectSourceField(\'' + key + '\')">' +
      '<span class="ext-label">' + badge + ' ' + label + '</span>' +
      '<span class="ext-value">' + value + '</span>' +
    '</div>';
  }).join('');

  // Legend
  var legendHtml = '<div class="legend">';
  Object.keys(FELD_COLORS).forEach(function(key) {
    legendHtml += '<div class="legend-item"><span class="legend-dot" style="background:' + FELD_COLORS[key].color + ';"></span>' + FELD_COLORS[key].label + '</div>';
  });
  legendHtml += '</div>';

  // Tab buttons
  var tabsHtml = '<div class="doc-tabs">' +
    '<button class="doc-tab' + (state.activeTab === 'doc' ? ' active' : '') + '" onclick="switchDocTab(\'doc\')"' + (!hasFile ? ' disabled style="opacity:0.4;cursor:not-allowed;"' : '') + '>' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px;"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Dokument' +
    '</button>' +
    '<button class="doc-tab' + (state.activeTab === 'text' ? ' active' : '') + '" onclick="switchDocTab(\'text\')">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px;"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>Text' +
    '</button>' +
  '</div>';

  document.getElementById('modal-body').innerHTML =
    '<div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center;">' +
      statusLabel(b.status) +
      '<span style="font-size:0.82rem;color:var(--text-dim);">Methode: <strong>' + (b.extraktion_methode || '-') + '</strong></span>' +
      '<span style="font-size:0.82rem;">Konfidenz: <strong class="konfidenz-' + (b.extraktion_konfidenz || 'niedrig') + '">' + (b.extraktion_konfidenz || '-') + '</strong></span>' +
      '<span style="font-size:0.82rem;color:var(--text-dim);">OCR: ' + (b.ocr_konfidenz ? b.ocr_konfidenz.toFixed(1) + '%' : '-') + '</span>' +
    '</div>' +
    legendHtml +
    '<div class="source-view" id="source-view-container">' +
      '<svg class="source-connector-svg" id="connector-svg"></svg>' +
      '<div>' +
        tabsHtml +
        '<div id="doc-tab-content" style="display:' + (state.activeTab === 'doc' ? 'block' : 'none') + ';">' +
          '<div class="pdf-container" id="pdf-container"><div class="pdf-canvas-wrap" id="pdf-canvas-wrap"><div style="padding:40px;text-align:center;color:var(--text-dim);">Dokument wird geladen...</div></div></div>' +
        '</div>' +
        '<div id="text-tab-content" style="display:' + (state.activeTab === 'text' ? 'block' : 'none') + ';">' +
          '<div class="ocr-panel" id="ocr-panel">' + ocrHtml + '</div>' +
        '</div>' +
      '</div>' +
      '<div>' +
        '<div style="font-size:0.74rem;font-weight:600;color:var(--text-dim);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">Extrahierte Daten</div>' +
        '<div class="extraction-panel" id="extraction-panel">' + (fieldsHtml || '<p style="color:var(--text-dim);">Keine Extraktion</p>') + '</div>' +
        ((['extrahiert', 'geprueft'].indexOf(b.status) >= 0) ?
        '<div style="margin-top:16px;"><div class="form-group"><label class="form-label">Pruefnotiz</label><input class="form-input" id="pruefnotiz" value="' + (b.pruefnotiz || '') + '" placeholder="Optionale Notiz..."></div></div>' : '') +
      '</div>' +
    '</div>';

  // Footer buttons
  var canApprove = b.status === 'extrahiert';
  var canReprocess = b.status === 'fehler' || b.status === 'extrahiert';
  document.getElementById('modal-footer').innerHTML =
    '<button class="btn btn-danger btn-sm" onclick="deleteBeleg(' + b.id + ')">Loschen</button>' +
    '<div style="flex:1"></div>' +
    (canReprocess ? '<button class="btn btn-ghost" onclick="reprocessBeleg(' + b.id + ')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg> Neu verarbeiten</button>' : '') +
    (canApprove ? '<button class="btn btn-success" onclick="approveBeleg(' + b.id + ')">&#10003; Freigeben</button>' : '') +
    '<button class="btn btn-ghost" onclick="closeModal()">Schliessen</button>';

  document.getElementById('beleg-modal').classList.add('show');

  // Setup click-outside to deselect on text panel
  document.getElementById('ocr-panel').addEventListener('click', function(e) {
    if (!e.target.classList.contains('ocr-highlight')) {
      clearSourceSelection();
    }
  });

  // Render document if doc tab is active and file exists
  if (state.activeTab === 'doc' && hasFile) {
    renderDocument(b, fileUrl);
  }
}

function buildSourceGroundedText(text, spans) {
  if (!spans || spans.length === 0) return escHtml(text);

  var sorted = spans.slice().sort(function(a, b) { return a.start - b.start; });
  var result = '';
  var pos = 0;

  for (var i = 0; i < sorted.length; i++) {
    var span = sorted[i];
    if (span.start < pos) continue;
    if (span.start > pos) {
      result += escHtml(text.slice(pos, span.start));
    }
    var highlighted = text.slice(span.start, span.end);
    var feld = span.feld || '';
    var tooltip = getFeldLabel(feld) + ': ' + highlighted.substring(0, 60);
    result += '<span class="ocr-highlight" data-feld="' + feld + '" data-tooltip="' + escAttr(tooltip) + '" onclick="selectSourceFieldFromOCR(\'' + feld + '\')">' + escHtml(highlighted) + '</span>';
    pos = span.end;
  }
  if (pos < text.length) {
    result += escHtml(text.slice(pos));
  }
  return result;
}

function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escAttr(s) { return s.replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// ── Document Viewer (PDF.js + Image) ──

function getFileUrl(dateipfad) {
  // Convert absolute server path to relative URL: "/uploads/1/2024/abc_file.pdf"
  if (!dateipfad) return null;
  var parts = dateipfad.split('uploads');
  if (parts.length >= 2) return '/uploads' + parts[parts.length - 1];
  return '/uploads/' + dateipfad;
}

function switchDocTab(tab) {
  state.activeTab = tab;
  state.activeField = null;
  clearSourceSelection();

  // Update tab buttons
  document.querySelectorAll('.doc-tab').forEach(function(el, i) {
    el.classList.toggle('active', (i === 0 && tab === 'doc') || (i === 1 && tab === 'text'));
  });

  // Toggle content
  var docContent = document.getElementById('doc-tab-content');
  var textContent = document.getElementById('text-tab-content');
  if (docContent) docContent.style.display = tab === 'doc' ? 'block' : 'none';
  if (textContent) textContent.style.display = tab === 'text' ? 'block' : 'none';

  // Render document if switching to doc tab for the first time
  if (tab === 'doc' && state.currentBeleg && state.currentBeleg.dateipfad) {
    var wrap = document.getElementById('pdf-canvas-wrap');
    if (wrap && !wrap.querySelector('canvas') && !wrap.querySelector('img')) {
      renderDocument(state.currentBeleg, getFileUrl(state.currentBeleg.dateipfad));
    }
  }
}

async function renderDocument(beleg, fileUrl) {
  var wrap = document.getElementById('pdf-canvas-wrap');
  if (!wrap || !fileUrl) return;

  var ext = beleg.dateityp || '';
  var isPdf = ext === 'pdf';
  var isImage = ['jpg','jpeg','png','tiff','bmp','webp'].indexOf(ext) >= 0;

  wrap.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-dim);">Wird geladen...</div>';

  try {
    if (isPdf && window.pdfjsLib) {
      // Render PDF page 1 via PDF.js
      var pdf = await pdfjsLib.getDocument(fileUrl).promise;
      var page = await pdf.getPage(1);
      var viewport = page.getViewport({ scale: 1 });

      // Scale to fit container width
      var container = document.getElementById('pdf-container');
      var containerWidth = container.clientWidth - 2;  // minus borders
      var scale = containerWidth / viewport.width;
      var scaledViewport = page.getViewport({ scale: scale });

      wrap.innerHTML = '';
      var canvas = document.createElement('canvas');
      canvas.className = 'pdf-canvas';
      canvas.width = scaledViewport.width;
      canvas.height = scaledViewport.height;
      wrap.appendChild(canvas);

      var ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;

      // Render bounding box overlay
      renderBboxOverlay(beleg, scaledViewport.width, scaledViewport.height, 1);

    } else if (isImage) {
      // Render image directly
      wrap.innerHTML = '';
      var img = document.createElement('img');
      img.className = 'pdf-img';
      img.src = fileUrl;
      img.onload = function() {
        renderBboxOverlay(beleg, img.clientWidth, img.clientHeight, 1);
      };
      img.onerror = function() {
        wrap.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-dim);">Bild konnte nicht geladen werden</div>';
      };
      wrap.appendChild(img);

    } else if (isPdf && !window.pdfjsLib) {
      // PDF.js not loaded – fallback
      wrap.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-dim);">PDF.js nicht verfuegbar – wechsle zum Text-Tab</div>';
      switchDocTab('text');

    } else {
      wrap.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-dim);">Dateityp "' + ext + '" nicht unterstuetzt</div>';
    }
  } catch(e) {
    console.error('Document render error:', e);
    wrap.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-dim);">Fehler beim Laden: ' + escHtml(e.message || 'Unbekannt') + '</div>';
  }
}

function renderBboxOverlay(beleg, displayWidth, displayHeight, pageNum) {
  var wrap = document.getElementById('pdf-canvas-wrap');
  if (!wrap) return;

  // Remove existing overlay
  var existing = wrap.querySelector('.bbox-overlay');
  if (existing) existing.remove();

  var spans = beleg.quellreferenzen || [];
  var spansWithBbox = spans.filter(function(s) { return s.bbox && s.bbox.page === pageNum; });
  if (spansWithBbox.length === 0) return;

  // Get original page dimensions from ocr_daten
  var ocrPage = null;
  if (beleg.ocr_daten && beleg.ocr_daten.pages) {
    ocrPage = beleg.ocr_daten.pages.find(function(p) { return p.page === pageNum; });
  }
  if (!ocrPage) return;

  var scaleX = displayWidth / ocrPage.width;
  var scaleY = displayHeight / ocrPage.height;

  // Create SVG overlay
  var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('class', 'bbox-overlay');
  svg.setAttribute('viewBox', '0 0 ' + displayWidth + ' ' + displayHeight);
  svg.setAttribute('width', displayWidth);
  svg.setAttribute('height', displayHeight);

  spansWithBbox.forEach(function(span) {
    var bb = span.bbox;
    var x = bb.x * scaleX;
    var y = bb.y * scaleY;
    var w = bb.w * scaleX;
    var h = bb.h * scaleY;
    var color = getFeldColor(span.feld);

    var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', w);
    rect.setAttribute('height', h);
    rect.setAttribute('fill', color);
    rect.setAttribute('fill-opacity', '0.15');
    rect.setAttribute('stroke', color);
    rect.setAttribute('stroke-width', '2');
    rect.setAttribute('rx', '3');
    rect.setAttribute('data-feld', span.feld || '');
    rect.setAttribute('data-bbox-feld', span.feld || '');
    rect.onclick = function(e) { e.stopPropagation(); selectSourceField(span.feld); };

    // Tooltip via title element
    var title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
    title.textContent = getFeldLabel(span.feld) + ': ' + (span.text || '').substring(0, 60);
    rect.appendChild(title);

    svg.appendChild(rect);
  });

  wrap.appendChild(svg);
}

// ── Source Grounding Interaktivitat ──

function selectSourceField(feld) {
  if (state.activeField === feld) {
    clearSourceSelection();
    return;
  }
  state.activeField = feld;

  // Dim all extraction fields, activate selected
  document.querySelectorAll('.ext-field').forEach(function(el) {
    el.classList.toggle('active-field', el.dataset.fieldKey === feld);
    el.classList.toggle('dimmed', el.dataset.fieldKey !== feld);
  });

  if (state.activeTab === 'doc') {
    // Document tab: highlight bounding boxes
    document.querySelectorAll('.bbox-overlay rect[data-bbox-feld]').forEach(function(el) {
      var match = el.getAttribute('data-bbox-feld') === feld;
      if (match) {
        el.setAttribute('fill-opacity', '0.3');
        el.setAttribute('stroke-width', '3');
        el.classList.add('active-bbox');
        el.classList.remove('dimmed');
        // Scroll bbox into view
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        el.setAttribute('fill-opacity', '0.05');
        el.setAttribute('stroke-width', '1');
        el.classList.add('dimmed');
        el.classList.remove('active-bbox');
      }
    });
  }

  if (state.activeTab === 'text') {
    // Text tab: highlight OCR text spans (existing behavior)
    document.querySelectorAll('.ocr-highlight').forEach(function(el) {
      var match = el.dataset.feld === feld;
      el.classList.toggle('active-highlight', match);
      el.classList.toggle('dimmed', !match);
      if (match) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  }

  // Draw connector (works in both tabs)
  drawConnector(feld);
}

function selectSourceFieldFromOCR(feld) {
  selectSourceField(feld);
}

function clearSourceSelection() {
  state.activeField = null;
  document.querySelectorAll('.ext-field').forEach(function(el) {
    el.classList.remove('active-field', 'dimmed');
  });
  document.querySelectorAll('.ocr-highlight').forEach(function(el) {
    el.classList.remove('active-highlight', 'dimmed');
  });
  // Reset bounding boxes to default state
  document.querySelectorAll('.bbox-overlay rect[data-bbox-feld]').forEach(function(el) {
    el.setAttribute('fill-opacity', '0.15');
    el.setAttribute('stroke-width', '2');
    el.classList.remove('active-bbox', 'dimmed');
  });
  clearConnectors();
}

function drawConnector(feld) {
  var svg = document.getElementById('connector-svg');
  if (!svg) return;
  svg.innerHTML = '';

  var container = document.getElementById('source-view-container');
  if (!container) return;
  var containerRect = container.getBoundingClientRect();

  // Find extraction field element
  var fieldEl = document.querySelector('.ext-field[data-field-key="' + feld + '"]');
  if (!fieldEl) return;

  var sourceEl = null;
  if (state.activeTab === 'doc') {
    // Doc tab: connect from bounding box
    sourceEl = document.querySelector('.bbox-overlay rect.active-bbox[data-bbox-feld="' + feld + '"]');
  }
  if (!sourceEl && state.activeTab === 'text') {
    // Text tab: connect from OCR highlight
    sourceEl = document.querySelector('.ocr-highlight.active-highlight[data-feld="' + feld + '"]');
  }
  if (!sourceEl) return;

  var fieldRect = fieldEl.getBoundingClientRect();
  var sourceRect = sourceEl.getBoundingClientRect();

  // Calculate positions relative to container
  var x1 = sourceRect.right - containerRect.left;
  var y1 = sourceRect.top + sourceRect.height / 2 - containerRect.top;
  var x2 = fieldRect.left - containerRect.left;
  var y2 = fieldRect.top + fieldRect.height / 2 - containerRect.top;

  // Bezier control points
  var cx = (x1 + x2) / 2;
  var color = getFeldColor(feld);

  var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', 'M ' + x1 + ' ' + y1 + ' C ' + cx + ' ' + y1 + ', ' + cx + ' ' + y2 + ', ' + x2 + ' ' + y2);
  path.setAttribute('class', 'connector-line active');
  path.setAttribute('stroke', color);
  svg.appendChild(path);
}

function clearConnectors() {
  var svg = document.getElementById('connector-svg');
  if (svg) svg.innerHTML = '';
}

function closeModal() {
  state.activeField = null;
  state.currentBeleg = null;
  state.activeTab = 'doc';
  document.getElementById('beleg-modal').classList.remove('show');
}

async function approveBeleg(id) {
  var notiz = document.getElementById('pruefnotiz');
  await api('/api/belege/' + id, {
    method: 'PUT',
    body: JSON.stringify({ manuell_geprueft: true, pruefnotiz: notiz ? notiz.value : '' }),
  });
  closeModal();
  await loadBelege();
}

async function reprocessBeleg(id) {
  await api('/api/belege/' + id + '/reprocess', { method: 'POST' });
  closeModal();
  setTimeout(loadBelege, 2000);
}

async function deleteBeleg(id) {
  if (!confirm('Beleg loschen?')) return;
  await api('/api/belege/' + id, { method: 'DELETE' });
  closeModal();
  await loadBelege();
}

// ── DATEV ────────────────────────────
async function checkDATEV() {
  try {
    var status = await api('/api/datev/status');
    var dot = document.getElementById('datev-dot');
    var label = document.getElementById('datev-label');
    if (status.maesn_configured && status.connection && status.connection.connected) {
      dot.className = 'datev-dot connected';
      label.textContent = 'DATEV verbunden';
    } else if (status.maesn_configured) {
      dot.className = 'datev-dot disconnected';
      label.textContent = 'Maesn konfiguriert';
    } else {
      dot.className = 'datev-dot disconnected';
      label.textContent = 'Nicht verbunden';
    }
  } catch(e) { console.error(e); }
}

async function loadDATEVStatus() {
  try {
    var status = await api('/api/datev/status');
    var conn = document.getElementById('datev-connection');
    if (status.maesn_configured) {
      conn.innerHTML = (status.connection && status.connection.connected)
        ? '<span style="color:var(--datev-green);font-weight:600;">&#10003; Maesn verbunden</span><br><span style="font-size:0.78rem;color:var(--text-dim);">Sandbox: ' + (status.sandbox ? 'Ja' : 'Nein') + '</span>'
        : '<span style="color:var(--warning);font-weight:600;">Maesn konfiguriert, Verbindung fehlgeschlagen</span>';
    } else {
      conn.innerHTML = '<span style="color:var(--text-dim);">Maesn API Key in .env konfigurieren</span><br><span style="font-size:0.78rem;">&rarr; <a href="https://www.maesn.com" target="_blank" style="color:var(--accent);">maesn.com</a></span>';
    }

    var ready = state.belege.filter(function(b) { return b.manuell_geprueft && b.datev_sync_status !== 'synced'; }).length;
    var synced = state.belege.filter(function(b) { return b.datev_sync_status === 'synced'; }).length;
    var errors = state.belege.filter(function(b) { return b.datev_sync_status === 'error'; }).length;
    document.getElementById('datev-ready').textContent = ready;
    document.getElementById('datev-synced').textContent = synced;
    document.getElementById('datev-errors').textContent = errors;

  } catch(e) { console.error(e); }
}

async function syncToDATEV(includeUnreviewed) {
  if (!state.steuerjahrId) return alert('Steuerjahr wahlen');
  try {
    var result = await api('/api/datev/sync', {
      method: 'POST',
      body: JSON.stringify({
        steuerjahr_id: state.steuerjahrId,
        nur_gepruefte: !includeUnreviewed,
      }),
    });
    alert('DATEV Sync: ' + (result.success || 0) + ' erfolgreich, ' + (result.errors || 0) + ' Fehler');
    await loadBelege();
    loadDATEVStatus();
  } catch(e) { alert('Sync-Fehler: ' + e.message); }
}

async function exportCSV() {
  if (!state.steuerjahrId) return alert('Steuerjahr wahlen');
  window.open('/api/datev/export/csv/' + state.steuerjahrId + '?nur_gepruefte=false', '_blank');
}

// ── Boot ─────────────────────────────
document.addEventListener('DOMContentLoaded', init);

// Auto-refresh every 10s if processing
setInterval(function() {
  if (state.belege.some(function(b) { return b.status === 'ocr_laeuft' || b.status === 'extraktion_laeuft'; })) {
    loadBelege();
  }
}, 10000);
</script>

</body>
</html>
